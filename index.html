<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roll 4 Focus Timer</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpolygon points='50,5 95,30 95,70 50,95 5,70 5,30' fill='%231e1929' stroke='%23c8963e' stroke-width='4'/%3E%3Cpolygon points='50,5 75,35 50,42 25,35' fill='%23c8963e' opacity='0.25'/%3E%3Cpolygon points='50,95 75,65 50,58 25,65' fill='%23c8963e' opacity='0.15'/%3E%3Cline x1='50' y1='5' x2='50' y2='42' stroke='%23c8963e' stroke-width='1.5' opacity='0.4'/%3E%3Cline x1='95' y1='30' x2='75' y2='35' stroke='%23c8963e' stroke-width='1.5' opacity='0.4'/%3E%3Cline x1='95' y1='70' x2='75' y2='65' stroke='%23c8963e' stroke-width='1.5' opacity='0.4'/%3E%3Cline x1='50' y1='95' x2='50' y2='58' stroke='%23c8963e' stroke-width='1.5' opacity='0.4'/%3E%3Cline x1='5' y1='70' x2='25' y2='65' stroke='%23c8963e' stroke-width='1.5' opacity='0.4'/%3E%3Cline x1='5' y1='30' x2='25' y2='35' stroke='%23c8963e' stroke-width='1.5' opacity='0.4'/%3E%3Ctext x='50' y='62' text-anchor='middle' font-family='serif' font-weight='bold' font-size='28' fill='%23e8b85a'%3E20%3C/text%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Cinzel:wght@400;600&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0b0e;
    --bg2: #131018;
    --bg3: #1a1622;
    --card: #1e1929;
    --border: #2e2640;
    --border2: #3d3458;
    --gold: #c8963e;
    --gold2: #e8b85a;
    --gold3: #f5d07a;
    --amber: #d4813a;
    --red: #c0392b;
    --red2: #e74c3c;
    --teal: #2eada8;
    --text: #e8dfc8;
    --text2: #b8a990;
    --text3: #7a6e5e;
    --success: #4caf82;
    --minion: #9b7fd4;
    --shadow: rgba(0,0,0,0.5);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'EB Garamond', Georgia, serif;
    min-height: 100vh;
    overflow-x: hidden;
    background-image:
      radial-gradient(ellipse at 20% 0%, rgba(200,150,62,0.06) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 100%, rgba(46,173,168,0.04) 0%, transparent 50%);
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0;
    opacity: 0.4;
  }

  /* APP HEADER */
  .app-header {
    text-align: center;
    padding: 24px 20px 0;
    position: relative;
    z-index: 1;
  }
  .app-title {
    font-family: 'Cinzel Decorative', serif;
    font-size: clamp(1.2rem, 3vw, 1.8rem);
    color: var(--gold2);
    letter-spacing: 0.08em;
    text-shadow: 0 0 30px rgba(200,150,62,0.4), 0 2px 4px rgba(0,0,0,0.6);
  }
  .app-subtitle {
    font-family: 'Cinzel', serif;
    font-size: 0.72rem;
    color: var(--text3);
    letter-spacing: 0.3em;
    text-transform: uppercase;
    margin-top: 4px;
  }
  .header-divider {
    width: 180px; height: 1px;
    background: linear-gradient(to right, transparent, var(--gold), transparent);
    margin: 12px auto 0;
    opacity: 0.5;
  }

  /* TABS */
  .tabs {
    display: flex;
    justify-content: center;
    gap: 0;
    padding: 16px 20px 0;
    position: relative; z-index: 1;
  }
  .tab-btn {
    font-family: 'Cinzel', serif;
    font-size: 0.78rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    background: none;
    border: 1px solid var(--border);
    color: var(--text3);
    padding: 9px 22px;
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
  }
  .tab-btn:first-child { border-radius: 4px 0 0 4px; }
  .tab-btn:last-child { border-radius: 0 4px 4px 0; }
  .tab-btn + .tab-btn { border-left: none; }
  .tab-btn + .tab-btn.active { border-left: 1px solid var(--gold); }
  .tab-btn:hover { color: var(--gold2); border-color: var(--border2); background: rgba(200,150,62,0.04); }
  .tab-btn.active {
    color: var(--gold2);
    background: rgba(200,150,62,0.08);
    border-color: var(--gold);
    box-shadow: 0 0 12px rgba(200,150,62,0.15);
  }

  /* MAIN CONTENT */
  .tab-content { display: none; padding: 24px 20px 40px; max-width: 680px; margin: 0 auto; position: relative; z-index: 1; }
  .tab-content.active { display: block; }

  /* CARDS */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
  }
  .card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(to right, transparent, rgba(200,150,62,0.3), transparent);
  }
  .card-title {
    font-family: 'Cinzel', serif;
    font-size: 0.7rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--gold);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(to right, var(--border2), transparent);
  }

  /* DICE ROW ‚Äî OCTAGONS */
  .dice-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    justify-items: center;
  }
  .die-field {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    width: 100%;
  }
  .die-label {
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }
  .die-field.hope .die-label { color: var(--teal); }
  .die-field.fear .die-label { color: var(--red2); }
  .die-field.soundtrack .die-label { color: var(--gold); }

  .die-oct-wrap {
    position: relative;
    width: min(100%, 110px);
    aspect-ratio: 1;
  }
  .die-oct-svg {
    position: absolute; inset: 0;
    width: 100%; height: 100%;
  }
  .die-oct-bg {
    fill: var(--bg3);
    stroke: var(--border2);
    stroke-width: 4;
  }
  .die-oct-accent {
    fill: none;
    stroke-width: 3;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .die-oct-wrap:focus-within .die-oct-accent { opacity: 1; }
  .hope-accent { stroke: var(--teal); filter: drop-shadow(0 0 4px rgba(46,173,168,0.5)); }
  .fear-accent { stroke: var(--red2); filter: drop-shadow(0 0 4px rgba(231,76,60,0.5)); }
  .gold-accent  { stroke: var(--gold); filter: drop-shadow(0 0 4px rgba(200,150,62,0.5)); }

  .die-oct-input {
    position: absolute; inset: 0;
    width: 100%; height: 100%;
    background: transparent;
    border: none;
    color: var(--text);
    font-family: 'Cinzel Decorative', serif;
    font-size: clamp(1.4rem, 3.5vw, 2rem);
    text-align: center;
    padding: 0;
    -moz-appearance: textfield;
    outline: none;
    /* Vertically center inside octagon */
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    padding-top: 8px;
  }
  .die-oct-input::-webkit-inner-spin-button,
  .die-oct-input::-webkit-outer-spin-button { -webkit-appearance: none; }
  .die-oct-input.hope { color: var(--teal); }
  .die-oct-input.fear { color: var(--red2); }

  /* SESSION + STATS SIDE BY SIDE */
  .session-stats-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
    align-items: start;
  }
  .session-card {
    margin-bottom: 0;
  }
  .stats-card {
    margin-bottom: 0;
    display: flex;
    flex-direction: column;
  }
  .stats-card .stats-col {
    flex: 1;
  }

  .stats-col {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .stat-field {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 8px;
    text-align: center;
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  /* ROLL FIELDS (legacy, kept for compatibility) */
  .roll-field label {
    display: block;
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .roll-field.hope label { color: var(--teal); }
  .roll-field.fear label { color: var(--red2); }
  .roll-field.soundtrack label { color: var(--gold); }

  .die-input {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border2);
    border-radius: 6px;
    color: var(--text);
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.5rem;
    text-align: center;
    padding: 10px 8px;
    transition: all 0.2s;
    -moz-appearance: textfield;
  }
  .die-input::-webkit-inner-spin-button,
  .die-input::-webkit-outer-spin-button { -webkit-appearance: none; }
  .die-input:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 2px rgba(200,150,62,0.15); }
  .die-input.hope:focus { border-color: var(--teal); box-shadow: 0 0 0 2px rgba(46,173,168,0.15); }
  .die-input.fear:focus { border-color: var(--red2); box-shadow: 0 0 0 2px rgba(231,76,60,0.15); }

  .btn-submit {
    width: 100%;
    font-family: 'Cinzel', serif;
    font-size: 0.78rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    background: linear-gradient(135deg, rgba(200,150,62,0.15), rgba(200,150,62,0.08));
    border: 1px solid var(--gold);
    color: var(--gold2);
    padding: 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.25s;
    margin-top: 4px;
  }
  .btn-submit:hover {
    background: linear-gradient(135deg, rgba(200,150,62,0.25), rgba(200,150,62,0.15));
    box-shadow: 0 0 16px rgba(200,150,62,0.2);
    transform: translateY(-1px);
  }
  .btn-submit:active { transform: translateY(0); }

  .btn-roll-for-me {
    font-family: 'Cinzel', serif;
    font-size: 0.58rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    background: none;
    border: 1px solid var(--border2);
    color: var(--text3);
    padding: 3px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 6px;
    vertical-align: middle;
  }
  .btn-roll-for-me:hover {
    border-color: var(--teal);
    color: var(--teal);
    box-shadow: none;
    transform: none;
  }

  /* SOUNDTRACK DISPLAY */
  .soundtrack-display {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 14px;
    font-style: italic;
    color: var(--text2);
    font-size: 0.95rem;
    min-height: 42px;
    display: flex;
    align-items: center;
  }
  .soundtrack-display.populated {
    color: var(--gold3);
    border-color: rgba(200,150,62,0.3);
  }

  /* TIMER ‚Äî THE CENTREPIECE */
  .timer-centrepiece {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 20px;
    position: relative;
  }

  .timer-ring-container {
    position: relative;
    width: 220px; height: 220px;
    margin-bottom: 20px;
  }
  .timer-ring-svg {
    position: absolute; inset: 0;
    transform: rotate(-90deg);
  }
  .timer-ring-bg { fill: none; stroke: var(--border); stroke-width: 4; }
  .timer-ring-progress {
    fill: none;
    stroke: var(--gold);
    stroke-width: 4;
    stroke-linecap: round;
    stroke-dasharray: 628;
    stroke-dashoffset: 0;
    transition: stroke-dashoffset 1s linear, stroke 0.5s;
    filter: drop-shadow(0 0 6px rgba(200,150,62,0.5));
  }
  .timer-ring-progress.low { stroke: var(--red2); filter: drop-shadow(0 0 6px rgba(231,76,60,0.5)); }

  .timer-inner {
    position: absolute; inset: 12px;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: radial-gradient(circle, var(--bg3) 60%, var(--bg2) 100%);
    border-radius: 50%;
  }
  .timer-display {
    font-family: 'Cinzel Decorative', serif;
    font-size: 2.6rem;
    color: var(--gold2);
    text-shadow: 0 0 20px rgba(200,150,62,0.4);
    line-height: 1;
    cursor: pointer;
    letter-spacing: 0.02em;
  }
  .timer-display:hover { color: var(--gold3); }
  .timer-edit {
    display: none;
    font-family: 'Cinzel Decorative', serif;
    font-size: 2rem;
    background: none;
    border: none;
    border-bottom: 1px solid var(--gold);
    color: var(--gold2);
    text-align: center;
    width: 160px;
    -moz-appearance: textfield;
    outline: none;
  }
  .timer-edit::-webkit-inner-spin-button { -webkit-appearance: none; }
  .timer-label {
    font-family: 'Cinzel', serif;
    font-size: 0.6rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--text3);
    margin-top: 4px;
  }

  .timer-controls {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .btn-timer {
    font-family: 'Cinzel', serif;
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    border-radius: 50px;
    padding: 10px 24px;
    cursor: pointer;
    border: 1px solid;
    transition: all 0.2s;
  }
  .btn-start {
    background: linear-gradient(135deg, rgba(76,175,130,0.2), rgba(76,175,130,0.1));
    border-color: var(--success);
    color: var(--success);
  }
  .btn-start:hover { background: rgba(76,175,130,0.25); box-shadow: 0 0 16px rgba(76,175,130,0.2); }
  .btn-pause {
    background: linear-gradient(135deg, rgba(200,150,62,0.2), rgba(200,150,62,0.1));
    border-color: var(--gold);
    color: var(--gold2);
  }
  .btn-pause:hover { background: rgba(200,150,62,0.25); box-shadow: 0 0 16px rgba(200,150,62,0.2); }
  .btn-reset {
    background: none;
    border-color: var(--border2);
    color: var(--text3);
    font-size: 0.65rem;
    padding: 8px 16px;
  }
  .btn-reset:hover { border-color: var(--red); color: var(--red2); }

  /* COUNTERS ROW */
  .counters-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
  }
  .counter-field {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    text-align: center;
  }
  .counter-label {
    font-family: 'Cinzel', serif;
    font-size: 0.58rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 8px;
  }
  .counter-label.inspiration { color: var(--gold); }
  .counter-label.dc { color: var(--teal); }
  .counter-label.minion-dc { color: var(--minion); }
  .dc-value.minion { color: var(--minion); }
  .counter-label.penalty { color: var(--red2); }
  .counter-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .counter-btn {
    width: 26px; height: 26px;
    background: var(--bg2);
    border: 1px solid var(--border2);
    border-radius: 4px;
    color: var(--text2);
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
    line-height: 1;
  }
  .counter-btn:hover { border-color: var(--gold); color: var(--gold2); }
  .counter-value {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.3rem;
    color: var(--text);
    min-width: 32px;
    text-align: center;
  }
  .counter-value.inspiration { color: var(--gold2); }
  .dc-value {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.3rem;
    color: var(--teal);
  }

  /* SETTINGS */
  .setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .setting-row:last-child { border-bottom: none; padding-bottom: 0; }
  .setting-label {
    font-family: 'Cinzel', serif;
    font-size: 0.72rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text2);
  }
  .setting-sub {
    font-family: 'EB Garamond', serif;
    font-size: 0.82rem;
    color: var(--text3);
    font-style: italic;
    margin-top: 2px;
  }
  .setting-control input[type="number"] {
    width: 80px;
    background: var(--bg3);
    border: 1px solid var(--border2);
    border-radius: 6px;
    color: var(--text);
    font-family: 'Cinzel Decorative', serif;
    font-size: 1rem;
    text-align: center;
    padding: 8px;
    -moz-appearance: textfield;
  }
  .setting-control input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
  .setting-control input[type="number"]:focus { outline: none; border-color: var(--gold); }

  .file-btn {
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text2);
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .file-btn:hover { border-color: var(--gold); color: var(--gold2); }
  #soundFileName {
    font-style: italic;
    color: var(--text3);
    font-size: 0.82rem;
    margin-top: 4px;
    text-align: right;
  }

  /* SOUNDTRACK TABLE */
  .soundtrack-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }
  .soundtrack-table thead tr {
    border-bottom: 1px solid var(--border2);
  }
  .soundtrack-table th {
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--gold);
    padding: 8px 12px;
    text-align: left;
  }
  .soundtrack-table td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    color: var(--text2);
    vertical-align: middle;
  }
  .soundtrack-table tbody tr:last-child td { border-bottom: none; }
  .soundtrack-table tbody tr:hover td { background: rgba(200,150,62,0.04); }
  .soundtrack-table td:first-child {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1rem;
    color: var(--gold3);
    text-align: center;
    width: 60px;
  }
  .soundtrack-table input[type="text"] {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 1px solid transparent;
    color: var(--text2);
    font-family: 'EB Garamond', serif;
    font-size: 0.9rem;
    padding: 2px 4px;
    transition: all 0.2s;
  }
  .soundtrack-table input[type="text"]:focus {
    outline: none;
    border-bottom-color: var(--gold);
    color: var(--text);
    background: rgba(200,150,62,0.04);
  }

  /* LOGS */
  .logs-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text3);
    font-style: italic;
  }
  .log-entry {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 14px 16px;
    margin-bottom: 10px;
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 12px;
    align-items: start;
    animation: logIn 0.3s ease;
  }
  @keyframes logIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
  .log-entry.success { border-left: 3px solid var(--success); }
  .log-entry.fail { border-left: 3px solid var(--red); }
  .log-dice {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  .log-die {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1rem;
    line-height: 1;
  }
  .log-die.hope { color: var(--teal); }
  .log-die.fear { color: var(--red2); }
  .log-die.sound { color: var(--gold); font-size: 0.8rem; }
  .log-details { font-size: 0.88rem; }
  .log-soundtrack { color: var(--text2); font-style: italic; margin-bottom: 4px; }
  .log-duration {
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text3);
  }
  .log-timestamp { font-size: 0.75rem; color: var(--text3); text-align: right; }
  .log-result {
    display: inline-block;
    font-family: 'Cinzel', serif;
    font-size: 0.6rem;
    letter-spacing: 0.15em;
    padding: 2px 8px;
    border-radius: 3px;
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  .log-result.success { background: rgba(76,175,130,0.15); color: var(--success); border: 1px solid rgba(76,175,130,0.3); }
  .log-result.fail { background: rgba(192,57,43,0.15); color: var(--red2); border: 1px solid rgba(192,57,43,0.3); }

  .btn-clear-logs {
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    background: none;
    border: 1px solid var(--border2);
    color: var(--text3);
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 16px;
    transition: all 0.2s;
  }
  .btn-clear-logs:hover { border-color: var(--red); color: var(--red2); }

  .btn-export-csv {
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    background: none;
    border: 1px solid var(--border2);
    color: var(--text3);
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 16px;
    transition: all 0.2s;
  }
  .btn-export-csv:hover { border-color: var(--teal); color: var(--teal); }

  .btn-status-reset {
    font-family: 'Cinzel', serif;
    font-size: 0.58rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    background: none;
    border: 1px solid var(--border2);
    color: var(--text3);
    padding: 3px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 6px;
    vertical-align: middle;
  }
  .btn-status-reset:hover { border-color: var(--red); color: var(--red2); }

  .btn-import-csv {
    font-family: 'Cinzel', serif;
    font-size: 0.58rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    background: none;
    border: 1px solid var(--border2);
    color: var(--text3);
    padding: 3px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 6px;
    vertical-align: middle;
  }
  .btn-import-csv:hover { border-color: var(--teal); color: var(--teal); }

  .sound-file-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* TOGGLE SWITCH */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
    cursor: pointer;
  }
  .toggle-switch input { display: none; }
  .toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--bg3);
    border: 1px solid var(--border2);
    border-radius: 24px;
    transition: all 0.25s;
  }
  .toggle-slider::before {
    content: '';
    position: absolute;
    width: 16px; height: 16px;
    left: 3px; top: 3px;
    background: var(--text3);
    border-radius: 50%;
    transition: all 0.25s;
  }
  .toggle-switch input:checked + .toggle-slider {
    background: rgba(200,150,62,0.15);
    border-color: var(--gold);
  }
  .toggle-switch input:checked + .toggle-slider::before {
    background: var(--gold2);
    transform: translateX(20px);
    box-shadow: 0 0 8px rgba(200,150,62,0.4);
  }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(4px);
    z-index: 100;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease;
  }
  .modal-overlay.show { display: flex; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .modal {
    background: var(--card);
    border: 1px solid var(--gold);
    border-radius: 12px;
    padding: 32px 28px;
    max-width: 360px;
    width: 90%;
    text-align: center;
    box-shadow: 0 0 60px rgba(200,150,62,0.2), 0 20px 60px rgba(0,0,0,0.5);
    animation: modalIn 0.25s ease;
    position: relative;
  }
  .modal::before {
    content: '';
    position: absolute; top: 0; left: 20%; right: 20%; height: 1px;
    background: linear-gradient(to right, transparent, var(--gold2), transparent);
  }
  @keyframes modalIn { from { transform: scale(0.9) translateY(20px); opacity: 0; } to { transform: none; opacity: 1; } }
  .modal-icon {
    font-size: 2.5rem;
    margin-bottom: 12px;
  }
  .modal-title {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.2rem;
    color: var(--gold2);
    margin-bottom: 8px;
  }
  .modal-subtitle {
    color: var(--text3);
    font-style: italic;
    font-size: 0.9rem;
    margin-bottom: 24px;
  }
  .modal-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .btn-yes {
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    background: linear-gradient(135deg, rgba(76,175,130,0.25), rgba(76,175,130,0.1));
    border: 1px solid var(--success);
    color: var(--success);
    padding: 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-yes:hover { background: rgba(76,175,130,0.3); box-shadow: 0 0 16px rgba(76,175,130,0.2); }
  .btn-no {
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    background: linear-gradient(135deg, rgba(192,57,43,0.2), rgba(192,57,43,0.08));
    border: 1px solid var(--red);
    color: var(--red2);
    padding: 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-no:hover { background: rgba(192,57,43,0.25); box-shadow: 0 0 16px rgba(192,57,43,0.2); }

  /* INSPIRATION FLASH */
  .inspiration-flash {
    position: fixed; inset: 0;
    pointer-events: none;
    z-index: 200;
    background: radial-gradient(ellipse at center, rgba(200,150,62,0.12) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.3s;
  }
  .inspiration-flash.show { opacity: 1; }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px; left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--card);
    border: 1px solid var(--gold);
    border-radius: 6px;
    padding: 10px 20px;
    font-family: 'Cinzel', serif;
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    color: var(--gold2);
    opacity: 0;
    transition: all 0.3s;
    z-index: 300;
    pointer-events: none;
    text-transform: uppercase;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  input[type="file"] { display: none; }

  .inline-counter {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .inline-counter .counter-btn {
    width: 28px; height: 28px;
  }
  .inline-counter .counter-value {
    font-size: 1.1rem;
    min-width: 28px;
  }

  /* NOTES */
  .notes-textarea {
    width: 100%;
    min-height: 140px;
    background: var(--bg3);
    border: 1px solid var(--border2);
    border-radius: 6px;
    color: var(--text);
    font-family: 'EB Garamond', Georgia, serif;
    font-size: 0.95rem;
    line-height: 1.6;
    padding: 12px 14px;
    resize: vertical;
    transition: border-color 0.2s;
    outline: none;
  }
  .notes-textarea:focus { border-color: var(--gold); box-shadow: 0 0 0 2px rgba(200,150,62,0.1); }
  .notes-textarea::placeholder { color: var(--text3); font-style: italic; }

  .notes-preview {
    min-height: 80px;
    padding: 12px 14px;
    background: var(--bg3);
    border: 1px solid var(--border2);
    border-radius: 6px;
    font-size: 0.95rem;
    line-height: 1.7;
    color: var(--text2);
  }
  .notes-preview h1,.notes-preview h2,.notes-preview h3 {
    font-family: 'Cinzel', serif;
    color: var(--gold2);
    margin: 0.8em 0 0.3em;
    letter-spacing: 0.05em;
  }
  .notes-preview h1 { font-size: 1.15rem; }
  .notes-preview h2 { font-size: 1rem; }
  .notes-preview h3 { font-size: 0.9rem; }
  .notes-preview p { margin: 0.4em 0; }
  .notes-preview strong { color: var(--gold3); font-weight: 600; }
  .notes-preview em { color: var(--text); font-style: italic; }
  .notes-preview code {
    font-family: monospace;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 1px 5px;
    font-size: 0.85rem;
    color: var(--teal);
  }
  .notes-preview pre {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 14px;
    overflow-x: auto;
    margin: 0.6em 0;
  }
  .notes-preview pre code { background: none; border: none; padding: 0; }
  .notes-preview ul,.notes-preview ol {
    padding-left: 1.4em;
    margin: 0.4em 0;
  }
  .notes-preview li { margin: 0.2em 0; }
  .notes-preview blockquote {
    border-left: 3px solid var(--gold);
    margin: 0.6em 0;
    padding: 4px 0 4px 14px;
    color: var(--text3);
    font-style: italic;
  }
  .notes-preview hr {
    border: none;
    border-top: 1px solid var(--border2);
    margin: 0.8em 0;
  }
  .notes-preview a { color: var(--teal); }
</style>
</head>
<body>

<div class="inspiration-flash" id="inspFlash"></div>

<header class="app-header">
  <div class="app-title">Roll 4 Focus</div>
  <div class="app-subtitle">Gamified Pomodoro Timer</div>
  <div class="header-divider"></div>
</header>

<nav class="tabs">
  <button class="tab-btn active" onclick="switchTab('timer')">Timer</button>
  <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
  <button class="tab-btn" onclick="switchTab('logs')">Logs</button>
  <button class="tab-btn" onclick="switchTab('notes')">Notes</button>
</nav>

<!-- ======================== TIMER TAB ======================== -->
<div id="tab-timer" class="tab-content active">

  <!-- Rolls Card -->
  <div class="card">
    <div class="card-title">Roll the Dice <button class="btn-roll-for-me" onclick="rollForMe()">üé≤ Roll for Me</button></div>
    <div class="dice-row">
      <div class="die-field hope">
        <div class="die-label">Hope</div>
        <div class="die-oct-wrap">
          <svg class="die-oct-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <polygon class="die-oct-bg" points="29,4 71,4 96,29 96,71 71,96 29,96 4,71 4,29"/>
            <polygon class="die-oct-accent hope-accent" points="29,4 71,4 96,29 96,71 71,96 29,96 4,71 4,29"/>
          </svg>
          <input type="number" class="die-oct-input hope" id="hopeRoll" min="1" max="20" placeholder="‚Äî"
            oninput="onHopeInput(this.value)" onchange="onHopeInput(this.value)">
        </div>
      </div>
      <div class="die-field fear">
        <div class="die-label">Fear</div>
        <div class="die-oct-wrap">
          <svg class="die-oct-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <polygon class="die-oct-bg" points="29,4 71,4 96,29 96,71 71,96 29,96 4,71 4,29"/>
            <polygon class="die-oct-accent fear-accent" points="29,4 71,4 96,29 96,71 71,96 29,96 4,71 4,29"/>
          </svg>
          <input type="number" class="die-oct-input fear" id="fearRoll" min="1" max="20" placeholder="‚Äî"
            oninput="onRollInput()" onchange="onRollInput()">
        </div>
      </div>
      <div class="die-field soundtrack">
        <div class="die-label">Soundtrack</div>
        <div class="die-oct-wrap">
          <svg class="die-oct-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <polygon class="die-oct-bg" points="29,4 71,4 96,29 96,71 71,96 29,96 4,71 4,29"/>
            <polygon class="die-oct-accent gold-accent" points="29,4 71,4 96,29 96,71 71,96 29,96 4,71 4,29"/>
          </svg>
          <input type="number" class="die-oct-input" id="soundRoll" min="1" max="20" placeholder="‚Äî"
            oninput="onSoundInput()" onchange="onSoundInput()">
        </div>
      </div>
    </div>
  </div>

  <!-- Soundtrack Display (moved here, right below Roll the Dice) -->
  <div class="card">
    <div class="card-title">Soundtrack <button class="btn-roll-for-me" onclick="rerollSoundtrack()">üé≤ Reroll Soundtrack</button></div>
    <div class="soundtrack-display" id="soundtrackDisplay">‚Äî Roll the dice to reveal your soundtrack ‚Äî</div>
  </div>

  <!-- Session + Stats side by side -->
  <div class="session-stats-row">

    <!-- Timer Centrepiece (2/3) -->
    <div class="card session-card">
      <div class="card-title">Session</div>
      <div class="timer-centrepiece">
        <div class="timer-ring-container">
          <svg class="timer-ring-svg" viewBox="0 0 220 220">
            <circle class="timer-ring-bg" cx="110" cy="110" r="100"/>
            <circle class="timer-ring-progress" id="timerRing" cx="110" cy="110" r="100"/>
          </svg>
          <div class="timer-inner">
            <div class="timer-display" id="timerDisplay" onclick="startEdit()" title="Click to edit">‚Äî:‚Äî‚Äî</div>
            <input type="text" class="timer-edit" id="timerEdit" placeholder="MM:SS" onblur="finishEdit()" onkeydown="editKeydown(event)">
            <div class="timer-label">Click to adjust</div>
          </div>
        </div>
        <div class="timer-controls">
          <button class="btn-timer btn-start" id="btnStart" onclick="startTimer()">‚ñ∂ Start</button>
          <button class="btn-timer btn-pause" id="btnPause" onclick="pauseTimer()" style="display:none">‚è∏ Pause</button>
          <button class="btn-timer btn-reset" onclick="resetTimer()">‚Ü∫ Reset</button>
        </div>
      </div>
    </div>

    <!-- Stats (1/3) -->
    <div class="card stats-card">
      <div class="card-title">Stats <button class="btn-status-reset" onclick="resetStatus()" title="Reset inspiration, penalty & DCs to defaults">‚Ü∫ Reset</button></div>
      <div class="stats-col">
        <div class="stat-field">
          <div class="counter-label inspiration">Inspiration</div>
          <div class="counter-controls">
            <button class="counter-btn" onclick="adjustCounter('inspiration', -1)">‚àí</button>
            <div class="counter-value inspiration" id="inspirationVal">0</div>
            <button class="counter-btn" onclick="adjustCounter('inspiration', 1)">+</button>
          </div>
        </div>
        <div class="stat-field">
          <div class="counter-label penalty">Penalty</div>
          <div class="counter-controls">
            <button class="counter-btn" onclick="adjustCounter('penalty', -1)">‚àí</button>
            <div class="counter-value" id="penaltyVal">0</div>
            <button class="counter-btn" onclick="adjustCounter('penalty', 1)">+</button>
          </div>
        </div>
        <div class="stat-field">
          <div class="counter-label dc">Boss DC</div>
          <div class="counter-controls">
            <button class="counter-btn" onclick="adjustDC('boss', -1)">‚àí</button>
            <div class="dc-value" id="bossDCVal">24</div>
            <button class="counter-btn" onclick="adjustDC('boss', 1)">+</button>
          </div>
        </div>
        <div class="stat-field">
          <div class="counter-label minion-dc">Minion DC</div>
          <div class="counter-controls">
            <button class="counter-btn" onclick="adjustDC('minion', -1)">‚àí</button>
            <div class="dc-value minion" id="minionDCVal">18</div>
            <button class="counter-btn" onclick="adjustDC('minion', 1)">+</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Notes -->
  <div class="card">
    <div class="card-title">
      Notes
      <button class="btn-status-reset" onclick="toggleNotesMode()" id="notesModeBtn" title="Toggle edit/preview">‚úé Edit</button>
    </div>
    <div id="notesEditor">
      <textarea id="notesInput" class="notes-textarea" placeholder="Session notes... (supports **bold**, *italic*, # headings, - lists, `code`, etc.)" oninput="saveNotes()"></textarea>
    </div>
    <div id="notesPreview" class="notes-preview" style="display:none"></div>
  </div>

</div>

<!-- ======================== SETTINGS TAB ======================== -->
<div id="tab-settings" class="tab-content">

  <div class="card">
    <div class="card-title">Timer Settings</div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Base Time</div>
        <div class="setting-sub">Minimum session length added to all rolls</div>
      </div>
      <div class="setting-control">
        <input type="number" id="baseTimeSetting" value="10" min="1" max="60" onchange="saveSettings()"> <span style="color:var(--text3);font-size:0.8rem;margin-left:4px;">min</span>
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Boss DC</div>
        <div class="setting-sub">Default DC before inspiration/penalty modifiers</div>
      </div>
      <div class="setting-control">
        <input type="number" id="dcDefaultSetting" value="24" min="1" max="30" onchange="saveSettings()">
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Minion DC</div>
        <div class="setting-sub">Lower DC for minor breaks/distractions</div>
      </div>
      <div class="setting-control">
        <input type="number" id="minionDcDefaultSetting" value="18" min="1" max="30" onchange="saveSettings()">
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Hope / Fear Die</div>
        <div class="setting-sub">Number of sides for Hope & Fear rolls</div>
      </div>
      <div class="setting-control">
        <span style="color:var(--text3);font-size:0.8rem;margin-right:4px;">d</span><input type="number" id="hopeFearDieSetting" value="20" min="4" max="100" onchange="saveSettings()">
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Soundtrack Die</div>
        <div class="setting-sub">Number of sides for Soundtrack rolls</div>
      </div>
      <div class="setting-control">
        <span style="color:var(--text3);font-size:0.8rem;margin-right:4px;">d</span><input type="number" id="soundtrackDieSetting" value="20" min="4" max="100" onchange="saveSettings()">
      </div>
    </div>
  </div>

  <!-- Sound Settings -->
  <div class="card">
    <div class="card-title">Sound Settings</div>

    <!-- Timer Sound -->
    <div class="setting-row">
      <div>
        <div class="setting-label">Timer Sound</div>
        <div class="setting-sub" id="soundFileName">No file selected</div>
      </div>
      <div class="setting-control">
        <label class="file-btn" for="soundFileInput">Choose File</label>
        <input type="file" id="soundFileInput" accept=".mp3,.wav" onchange="loadSoundFile(event)">
      </div>
    </div>

    <!-- Ticking Sound -->
    <div class="setting-row">
      <div>
        <div class="setting-label">Ticking Sound</div>
        <div class="setting-sub">Soft clock tick while timer runs (4/sec)</div>
      </div>
      <div class="setting-control">
        <label class="toggle-switch">
          <input type="checkbox" id="tickingToggle" onchange="saveSettings()">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <!-- Session Start Sound -->
    <div class="setting-row">
      <div>
        <div class="setting-label">Session Start Sound</div>
        <div class="setting-sub" id="startSoundFileName">No file selected</div>
      </div>
      <div class="setting-control sound-file-control">
        <label class="toggle-switch">
          <input type="checkbox" id="startSoundToggle" onchange="saveSettings()">
          <span class="toggle-slider"></span>
        </label>
        <label class="file-btn" for="startSoundFileInput">Choose File</label>
        <input type="file" id="startSoundFileInput" accept=".mp3,.wav" onchange="loadStartSoundFile(event)">
      </div>
    </div>

    <!-- Inspiration Sound -->
    <div class="setting-row">
      <div>
        <div class="setting-label">Inspiration Sound</div>
        <div class="setting-sub" id="inspirationSoundFileName">No file selected</div>
      </div>
      <div class="setting-control sound-file-control">
        <label class="toggle-switch">
          <input type="checkbox" id="inspirationSoundToggle" onchange="saveSettings()">
          <span class="toggle-slider"></span>
        </label>
        <label class="file-btn" for="inspirationSoundFileInput">Choose File</label>
        <input type="file" id="inspirationSoundFileInput" accept=".mp3,.wav" onchange="loadInspirationSoundFile(event)">
      </div>
    </div>

  </div>

  <!-- Soundtrack Table -->
  <div class="card">
    <div class="card-title">Soundtrack Table
      <label class="btn-import-csv" for="soundtrackCsvInput" title="Import CSV with columns: Roll, Soundtrack">‚Üë Import CSV</label>
      <input type="file" id="soundtrackCsvInput" accept=".csv" onchange="importSoundtrackCSV(event)">
    </div>
    <table class="soundtrack-table">
      <thead>
        <tr>
          <th>Roll</th>
          <th>Soundtrack</th>
        </tr>
      </thead>
      <tbody id="soundtrackTableBody">
      </tbody>
    </table>
  </div>

</div>

<!-- ======================== LOGS TAB ======================== -->
<div id="tab-logs" class="tab-content">
  <div style="display:flex;gap:10px;margin-bottom:16px;">
    <button class="btn-clear-logs" onclick="clearLogs()">‚úï Clear All Logs</button>
    <button class="btn-export-csv" onclick="exportCSV()">‚Üì Export CSV</button>
  </div>
  <div id="logsContainer">
    <div class="logs-empty">No sessions logged yet.<br>Complete a session to see it here.</div>
  </div>
</div>

<!-- ======================== NOTES TAB ======================== -->
<div id="tab-notes" class="tab-content">
  <div class="card">
    <div class="card-title">
      Notes
      <button class="btn-status-reset" onclick="toggleNotesModeTab()" id="notesModeTabBtn" title="Toggle edit/preview">üëÅ Preview</button>
    </div>
    <div id="notesEditorTab">
      <textarea id="notesInputTab" class="notes-textarea" style="min-height:400px;" placeholder="Your notes... (supports **bold**, *italic*, # headings, - lists, `code`, etc.)" oninput="saveNotesTab()"></textarea>
    </div>
    <div id="notesPreviewTab" class="notes-preview" style="display:none; min-height:400px;"></div>
  </div>
</div>

<!-- ======================== MODAL ======================== -->
<div class="modal-overlay" id="sessionModal">
  <div class="modal">
    <div class="modal-icon">‚öî</div>
    <div class="modal-title">Session Success?</div>
    <div class="modal-subtitle">Did you complete this session?</div>
    <div class="modal-buttons">
      <button class="btn-yes" onclick="sessionResult(true)">‚úì Yes!</button>
      <button class="btn-no" onclick="sessionResult(false)">‚úó No</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<audio id="timerSound"></audio>
<audio id="startSound"></audio>
<audio id="inspirationSound"></audio>

<script>
// ============================================================
// STATE
// ============================================================
const DEFAULT_SOUNDTRACKS = [
  "Binaural Focus Cafe",
  "MyNoise ‚Äì Pure Tones for Focus",
  "Spotify ‚Äì World Music for Focus",
  "Spotify ‚Äì Focus Groove",
  "Spotify ‚Äì Focus Mix",
  "Launchy ‚Äì Dannic Groove Cruise OR SomaFM thetrip",
  "Launchy ‚Äì Lifescapes Forest OR SomaFM Thistle (Celtic)",
  "Launchy ‚Äì SomaFM Suburbs of Goa",
  "Launchy ‚Äì SomaFM GrooveSalad",
  "Spotify ‚Äì Energico OR ADHD + Energico",
  "Spotify ‚Äì Focus Groove",
  "Launchy ‚Äì SomaFM GrooveSalad",
  "Launchy ‚Äì SomaFM GrooveSalad",
  "Launchy ‚Äì Dannic Groove Cruise OR SomaFM thetrip",
  "Podcast OR Roll Again",
  "Podcast OR Roll Again",
  "Your Choice!",
  "Your Choice!",
  "Your Choice!",
  "Your Choice!",
];

let state = {
  inspiration: 0,
  penalty: 0,
  baseTime: 10,
  dcDefault: 24,
  minionDcDefault: 18,
  hopeFearDie: 20,
  soundtrackDie: 20,
  tickingEnabled: false,
  startSoundEnabled: false,
  inspirationSoundEnabled: false,
  soundtracks: [...DEFAULT_SOUNDTRACKS],
  logs: [],
  timerSeconds: 0,
  timerTotal: 0,
  timerRunning: false,
  timerInterval: null,
  tickInterval: null,
  currentSession: null,
  soundFileURL: null,
};

// ============================================================
// PERSISTENCE
// ============================================================
function saveState() {
  const toSave = {
    inspiration: state.inspiration,
    penalty: state.penalty,
    baseTime: state.baseTime,
    dcDefault: state.dcDefault,
    minionDcDefault: state.minionDcDefault,
    hopeFearDie: state.hopeFearDie,
    soundtrackDie: state.soundtrackDie,
    tickingEnabled: state.tickingEnabled,
    startSoundEnabled: state.startSoundEnabled,
    inspirationSoundEnabled: state.inspirationSoundEnabled,
    soundtracks: state.soundtracks,
    logs: state.logs,
  };
  localStorage.setItem('r4f_state', JSON.stringify(toSave));
}

function loadState() {
  try {
    const saved = JSON.parse(localStorage.getItem('r4f_state') || '{}');
    if (saved.inspiration !== undefined) state.inspiration = saved.inspiration;
    if (saved.penalty !== undefined) state.penalty = saved.penalty;
    if (saved.baseTime !== undefined) state.baseTime = saved.baseTime;
    if (saved.dcDefault !== undefined) state.dcDefault = saved.dcDefault;
    if (saved.minionDcDefault !== undefined) state.minionDcDefault = saved.minionDcDefault;
    if (saved.hopeFearDie !== undefined) state.hopeFearDie = saved.hopeFearDie;
    if (saved.soundtrackDie !== undefined) state.soundtrackDie = saved.soundtrackDie;
    if (saved.tickingEnabled !== undefined) state.tickingEnabled = saved.tickingEnabled;
    if (saved.startSoundEnabled !== undefined) state.startSoundEnabled = saved.startSoundEnabled;
    if (saved.inspirationSoundEnabled !== undefined) state.inspirationSoundEnabled = saved.inspirationSoundEnabled;
    if (saved.soundtracks) state.soundtracks = saved.soundtracks;
    if (saved.logs) state.logs = saved.logs;
  } catch(e) {}
}

// ============================================================
// NOTES & MARKDOWN
// ============================================================
let notesMode = 'edit';
let notesModeTab = 'edit';

function saveNotes() {
  localStorage.setItem('r4f_notes', document.getElementById('notesInput').value);
}

function loadNotes() {
  const saved = localStorage.getItem('r4f_notes') || '';
  document.getElementById('notesInput').value = saved;
}

function toggleNotesMode() {
  const btn = document.getElementById('notesModeBtn');
  if (notesMode === 'edit') {
    notesMode = 'preview';
    const md = document.getElementById('notesInput').value;
    document.getElementById('notesPreview').innerHTML = parseMarkdown(md);
    document.getElementById('notesEditor').style.display = 'none';
    document.getElementById('notesPreview').style.display = 'block';
    btn.textContent = '‚úé Edit';
  } else {
    notesMode = 'edit';
    document.getElementById('notesEditor').style.display = 'block';
    document.getElementById('notesPreview').style.display = 'none';
    btn.textContent = 'üëÅ Preview';
  }
}

function saveNotesTab() {
  localStorage.setItem('r4f_notes_tab', document.getElementById('notesInputTab').value);
}

function loadNotesTab() {
  const saved = localStorage.getItem('r4f_notes_tab') || '';
  document.getElementById('notesInputTab').value = saved;
}

function toggleNotesModeTab() {
  const btn = document.getElementById('notesModeTabBtn');
  if (notesModeTab === 'edit') {
    notesModeTab = 'preview';
    const md = document.getElementById('notesInputTab').value;
    document.getElementById('notesPreviewTab').innerHTML = parseMarkdown(md);
    document.getElementById('notesEditorTab').style.display = 'none';
    document.getElementById('notesPreviewTab').style.display = 'block';
    btn.textContent = '‚úé Edit';
  } else {
    notesModeTab = 'edit';
    document.getElementById('notesEditorTab').style.display = 'block';
    document.getElementById('notesPreviewTab').style.display = 'none';
    btn.textContent = 'üëÅ Preview';
  }
}

function parseMarkdown(md) {
  // Escape HTML first
  let html = md
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  // Code blocks (``` ... ```)
  html = html.replace(/```([\s\S]*?)```/g, (_, code) =>
    `<pre><code>${code.trim()}</code></pre>`);

  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

  // Headings
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

  // Horizontal rule
  html = html.replace(/^---$/gm, '<hr>');

  // Blockquote
  html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');

  // Bold & italic
  html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  html = html.replace(/_(.+?)_/g, '<em>$1</em>');

  // Unordered lists
  html = html.replace(/((?:^[-*] .+\n?)+)/gm, (block) => {
    const items = block.trim().split('\n').map(l => `<li>${l.replace(/^[-*] /, '')}</li>`).join('');
    return `<ul>${items}</ul>`;
  });

  // Ordered lists
  html = html.replace(/((?:^\d+\. .+\n?)+)/gm, (block) => {
    const items = block.trim().split('\n').map(l => `<li>${l.replace(/^\d+\. /, '')}</li>`).join('');
    return `<ol>${items}</ol>`;
  });

  // Links
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

  // Paragraphs ‚Äî wrap lines that aren't already block elements
  html = html.replace(/^(?!<[a-z]|$)(.+)$/gm, '<p>$1</p>');

  // Clean up extra blank lines
  html = html.replace(/\n{2,}/g, '\n');

  return html;
}

// ============================================================
// TABS
// ============================================================
function switchTab(name) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  event.target.classList.add('active');
  if (name === 'logs') renderLogs();
}

// ============================================================
// ROLLS & SESSION SETUP
// ============================================================
function rerollSoundtrack() {
  const sound = Math.ceil(Math.random() * state.soundtrackDie);
  const el = document.getElementById('soundRoll');
  el.value = sound;
  el.dataset.userOverride = '1';
  el.style.transition = 'box-shadow 0.1s';
  el.style.boxShadow = '0 0 0 3px rgba(200,150,62,0.3)';
  setTimeout(() => el.style.boxShadow = '', 400);
  onRollInput();
}

function rollForMe() {
  const hope = Math.ceil(Math.random() * state.hopeFearDie);
  const fear = Math.ceil(Math.random() * state.hopeFearDie);
  const sound = Math.ceil(Math.random() * state.soundtrackDie);
  document.getElementById('hopeRoll').value = hope;
  document.getElementById('fearRoll').value = fear;
  // Clear override so soundtrack auto-populates from hope
  document.getElementById('soundRoll').removeAttribute('data-user-override');
  document.getElementById('soundRoll').value = sound;
  // Animate inputs briefly
  ['hopeRoll','fearRoll','soundRoll'].forEach(id => {
    const el = document.getElementById(id);
    el.style.transition = 'box-shadow 0.1s';
    el.style.boxShadow = '0 0 0 3px rgba(46,173,168,0.3)';
    setTimeout(() => el.style.boxShadow = '', 400);
  });
  onRollInput();
}

// ============================================================
// ROLLS & LIVE SESSION CALCULATION
// ============================================================
function onHopeInput(val) {
  // Auto-populate soundtrack with same value as hope unless user has overridden it
  const soundEl = document.getElementById('soundRoll');
  if (!soundEl.dataset.userOverride) {
    soundEl.value = val;
  }
  onRollInput();
}

function onSoundInput() {
  // Mark as user-overridden so hope no longer auto-fills it
  document.getElementById('soundRoll').dataset.userOverride = '1';
  onRollInput();
}

function onRollInput() {
  const hope = parseInt(document.getElementById('hopeRoll').value);
  const fear = parseInt(document.getElementById('fearRoll').value);
  const sound = parseInt(document.getElementById('soundRoll').value);

  if (hope >= 1 && hope <= 20 && fear >= 1 && fear <= 20) {
    let totalMinutes;
    const equalKey = `${hope}`;
    if (hope === fear) {
      totalMinutes = hope + state.baseTime;
      if (!state._lastEqualRoll || state._lastEqualRoll !== equalKey) {
        state._lastEqualRoll = equalKey;
        adjustCounter('inspiration', 1);
        playInspirationSound();
        showToast('Hope = Fear ‚Äî +1 Inspiration!');
      }
    } else {
      state._lastEqualRoll = null;
      totalMinutes = hope > fear ? hope + state.baseTime : hope + fear + state.baseTime;
    }
    state.currentSession = state.currentSession || {};
    state.currentSession.hope = hope;
    state.currentSession.fear = fear;
    state.currentSession.totalMinutes = totalMinutes;
    setTimer(totalMinutes * 60);
  }

  if (sound >= 1 && sound <= 20) {
    const name = state.soundtracks[sound - 1] || `Track ${sound}`;
    state.currentSession = state.currentSession || {};
    state.currentSession.sound = sound;
    state.currentSession.soundtrackName = name;
    document.getElementById('soundtrackDisplay').textContent = name;
    document.getElementById('soundtrackDisplay').classList.add('populated');
  } else {
    document.getElementById('soundtrackDisplay').textContent = '‚Äî Roll the dice to reveal your soundtrack ‚Äî';
    document.getElementById('soundtrackDisplay').classList.remove('populated');
  }
}

function submitRolls() {} // no-op, kept for safety

// ============================================================
// TIMER
// ============================================================
function setTimer(seconds) {
  state.timerSeconds = seconds;
  state.timerTotal = seconds;
  updateTimerDisplay();
  updateRing();
}

function updateTimerDisplay() {
  const mins = Math.floor(state.timerSeconds / 60);
  const secs = state.timerSeconds % 60;
  const str = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  document.getElementById('timerDisplay').textContent = str;
}

function updateRing() {
  const ring = document.getElementById('timerRing');
  const circumference = 628;
  if (state.timerTotal === 0) {
    ring.style.strokeDashoffset = 0;
    ring.classList.remove('low');
    return;
  }
  const frac = state.timerSeconds / state.timerTotal;
  ring.style.strokeDashoffset = circumference * (1 - frac);
  if (frac < 0.2) ring.classList.add('low');
  else ring.classList.remove('low');
}

function startTimer() {
  if (state.timerSeconds <= 0) { showToast('Set a session time first'); return; }
  state.timerRunning = true;
  document.getElementById('btnStart').style.display = 'none';
  document.getElementById('btnPause').style.display = 'inline-flex';
  playStartSound();
  startTicking();
  state.timerInterval = setInterval(() => {
    state.timerSeconds--;
    updateTimerDisplay();
    updateRing();
    if (state.timerSeconds <= 0) {
      clearInterval(state.timerInterval);
      stopTicking();
      state.timerRunning = false;
      playSound();
      document.getElementById('btnPause').style.display = 'none';
      document.getElementById('btnStart').style.display = 'inline-flex';
      setTimeout(() => document.getElementById('sessionModal').classList.add('show'), 500);
    }
  }, 1000);
}

function pauseTimer() {
  if (state.timerInterval) clearInterval(state.timerInterval);
  stopTicking();
  state.timerRunning = false;
  document.getElementById('btnPause').style.display = 'none';
  document.getElementById('btnStart').style.display = 'inline-flex';
}

function resetTimer() {
  pauseTimer();
  if (state.currentSession) {
    setTimer(state.currentSession.totalMinutes * 60);
  } else {
    state.timerSeconds = 0;
    state.timerTotal = 0;
    document.getElementById('timerDisplay').textContent = '‚Äî:‚Äî‚Äî';
    updateRing();
  }
}

// Manual edit
function startEdit() {
  if (state.timerRunning) return;
  const disp = document.getElementById('timerDisplay');
  const edit = document.getElementById('timerEdit');
  disp.style.display = 'none';
  edit.style.display = 'block';
  edit.value = disp.textContent === '‚Äî:‚Äî‚Äî' ? '' : disp.textContent;
  edit.focus();
  edit.select();
}

function finishEdit() {
  const disp = document.getElementById('timerDisplay');
  const edit = document.getElementById('timerEdit');
  const val = edit.value.trim();
  if (val) {
    let secs = 0;
    if (val.includes(':')) {
      const parts = val.split(':');
      secs = parseInt(parts[0] || 0) * 60 + parseInt(parts[1] || 0);
    } else {
      secs = parseInt(val) * 60;
    }
    if (!isNaN(secs) && secs > 0) {
      state.timerSeconds = secs;
      state.timerTotal = secs;
      updateRing();
    }
  }
  updateTimerDisplay();
  edit.style.display = 'none';
  disp.style.display = 'block';
}

function editKeydown(e) {
  if (e.key === 'Enter') finishEdit();
  if (e.key === 'Escape') {
    document.getElementById('timerEdit').style.display = 'none';
    document.getElementById('timerDisplay').style.display = 'block';
  }
}

// ============================================================
// SESSION RESULT MODAL
// ============================================================
function sessionResult(success) {
  document.getElementById('sessionModal').classList.remove('show');
  stopSound();
  if (success) {
    const duration = state.currentSession ? state.currentSession.totalMinutes : Math.round(state.timerTotal / 60);
    let bonus = 0;
    if (duration >= 40) bonus = 3;
    else if (duration >= 35) bonus = 2;
    else if (duration >= 30) bonus = 1;

    adjustCounter('inspiration', 1 + bonus);
    flashInspiration();
    playInspirationSound();

    if (bonus > 0) {
      showToast(`+${1 + bonus} Inspiration ‚Äî ${duration}m session bonus!`);
    } else {
      showToast('+1 Inspiration ‚Äî Session Complete!');
    }
  }
  // Log the session
  const session = state.currentSession || {};
  const log = {
    hope: session.hope || '‚Äî',
    fear: session.fear || '‚Äî',
    sound: session.sound || '‚Äî',
    soundtrack: session.soundtrackName || '‚Äî',
    duration: session.totalMinutes || Math.round(state.timerTotal / 60),
    success,
    timestamp: new Date().toLocaleString(),
  };
  state.logs.unshift(log);
  saveState();
}

// ============================================================
// COUNTERS
// ============================================================
function resetStatus() {
  state.inspiration = 0;
  state.penalty = 0;
  document.getElementById('inspirationVal').textContent = 0;
  document.getElementById('penaltyVal').textContent = 0;
  updateBreakDC();
  saveState();
  showToast('Status reset');
}

function adjustDC(which, delta) {
  if (which === 'boss') {
    state.dcDefault = Math.max(1, state.dcDefault + delta);
    const el = document.getElementById('dcDefaultSetting');
    if (el) el.value = state.dcDefault;
  } else {
    state.minionDcDefault = Math.max(1, state.minionDcDefault + delta);
    const el = document.getElementById('minionDcDefaultSetting');
    if (el) el.value = state.minionDcDefault;
  }
  updateBreakDC();
  saveState();
}

function adjustCounter(which, delta) {
  if (which === 'inspiration') {
    state.inspiration = Math.max(0, state.inspiration + delta);
    document.getElementById('inspirationVal').textContent = state.inspiration;
  } else if (which === 'penalty') {
    state.penalty = Math.max(0, state.penalty + delta);
    document.getElementById('penaltyVal').textContent = state.penalty;
  }
  updateBreakDC();
  saveState();
}

function updateBreakDC() {
  const bossDC = state.dcDefault - state.inspiration + state.penalty;
  const minionDC = state.minionDcDefault - state.inspiration + state.penalty;
  document.getElementById('bossDCVal').textContent = bossDC;
  document.getElementById('minionDCVal').textContent = minionDC;
}

// ============================================================
// SETTINGS
// ============================================================
function saveSettings() {
  state.baseTime = parseInt(document.getElementById('baseTimeSetting').value) || 10;
  state.dcDefault = parseInt(document.getElementById('dcDefaultSetting').value) || 24;
  state.minionDcDefault = parseInt(document.getElementById('minionDcDefaultSetting').value) || 18;
  state.hopeFearDie = parseInt(document.getElementById('hopeFearDieSetting').value) || 20;
  state.soundtrackDie = parseInt(document.getElementById('soundtrackDieSetting').value) || 20;
  state.tickingEnabled = document.getElementById('tickingToggle').checked;
  state.startSoundEnabled = document.getElementById('startSoundToggle').checked;
  state.inspirationSoundEnabled = document.getElementById('inspirationSoundToggle').checked;
  updateBreakDC();

  // Save soundtracks from table
  const rows = document.querySelectorAll('#soundtrackTableBody tr');
  rows.forEach((row, i) => {
    const input = row.querySelector('input[type="text"]');
    if (input) state.soundtracks[i] = input.value;
  });
  saveState();
}

function importSoundtrackCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const lines = e.target.result.split('\n').map(l => l.trim()).filter(l => l);
    // Skip header row if it contains non-numeric first column
    const dataLines = lines.filter(l => {
      const first = l.split(',')[0].replace(/"/g,'').trim();
      return !isNaN(parseInt(first));
    });
    if (dataLines.length === 0) { showToast('No valid rows found in CSV'); return; }
    dataLines.forEach(line => {
      // Handle quoted fields
      const match = line.match(/^"?(\d+)"?,(.+)$/);
      if (!match) return;
      const idx = parseInt(match[1]) - 1;
      const name = match[2].replace(/^"|"$/g, '').replace(/""/g, '"').trim();
      if (idx >= 0 && idx < state.soundtracks.length) {
        state.soundtracks[idx] = name;
      }
    });
    buildSoundtrackTable();
    saveState();
    showToast(`Imported ${dataLines.length} soundtrack(s)`);
    event.target.value = '';
  };
  reader.readAsText(file);
}

function buildSoundtrackTable() {
  const tbody = document.getElementById('soundtrackTableBody');
  tbody.innerHTML = '';
  for (let i = 0; i < state.soundtracks.length; i++) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td><input type="text" value="${escapeHtml(state.soundtracks[i])}" onblur="saveSettings()"></td>`;
    tbody.appendChild(tr);
  }
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;');
}

function loadSoundFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  document.getElementById('soundFileName').textContent = file.name;

  const reader = new FileReader();
  reader.onload = (e) => {
    const dataURL = e.target.result;
    state.soundFileURL = dataURL;
    state.soundFileName = file.name;
    document.getElementById('timerSound').src = dataURL;
    // Persist to localStorage (only if small enough ‚Äî warn if too large)
    try {
      localStorage.setItem('r4f_sound', JSON.stringify({ name: file.name, data: dataURL }));
    } catch(err) {
      showToast('File too large to persist ‚Äî re-select on next open');
    }
    saveState();
  };
  reader.readAsDataURL(file);
}

function startTicking() {
  if (!state.tickingEnabled) return;
  stopTicking();
  let audioCtx = null;
  try { audioCtx = new AudioContext(); } catch(e) { return; }
  state.tickInterval = setInterval(() => {
    if (!state.tickingEnabled) return;
    try {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.06, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.04);
      osc.start(audioCtx.currentTime);
      osc.stop(audioCtx.currentTime + 0.04);
    } catch(e) {}
  }, 250); // 4 ticks per second
}

function stopTicking() {
  if (state.tickInterval) {
    clearInterval(state.tickInterval);
    state.tickInterval = null;
  }
}

function loadStartSoundFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  document.getElementById('startSoundFileName').textContent = file.name;
  const reader = new FileReader();
  reader.onload = (e) => {
    const dataURL = e.target.result;
    document.getElementById('startSound').src = dataURL;
    try {
      localStorage.setItem('r4f_start_sound', JSON.stringify({ name: file.name, data: dataURL }));
    } catch(err) {
      showToast('File too large to persist ‚Äî re-select on next open');
    }
  };
  reader.readAsDataURL(file);
}

function loadInspirationSoundFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  document.getElementById('inspirationSoundFileName').textContent = file.name;
  const reader = new FileReader();
  reader.onload = (e) => {
    const dataURL = e.target.result;
    document.getElementById('inspirationSound').src = dataURL;
    try {
      localStorage.setItem('r4f_inspiration_sound', JSON.stringify({ name: file.name, data: dataURL }));
    } catch(err) {
      showToast('File too large to persist ‚Äî re-select on next open');
    }
  };
  reader.readAsDataURL(file);
}

function playStartSound() {
  if (!state.startSoundEnabled) return;
  const audio = document.getElementById('startSound');
  if (audio.src && audio.src !== window.location.href) {
    audio.currentTime = 0;
    audio.play().catch(() => {});
  }
}

function playInspirationSound() {
  if (!state.inspirationSoundEnabled) return;
  const audio = document.getElementById('inspirationSound');
  if (audio.src && audio.src !== window.location.href) {
    audio.currentTime = 0;
    audio.play().catch(() => {});
  }
}

function stopSound() {
  const audio = document.getElementById('timerSound');
  audio.pause();
  audio.currentTime = 0;
}

function playSound() {
  const audio = document.getElementById('timerSound');
  if (audio.src && audio.src !== window.location.href) {
    audio.currentTime = 0;
    audio.play().catch(() => {});
  } else {
    // Fallback beep using Web Audio
    try {
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.setValueAtTime(880, ctx.currentTime);
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.5);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 1.5);
    } catch(e) {}
  }
}

// ============================================================
// LOGS
// ============================================================
function renderLogs() {
  const container = document.getElementById('logsContainer');
  if (state.logs.length === 0) {
    container.innerHTML = '<div class="logs-empty">No sessions logged yet.<br>Complete a session to see it here.</div>';
    return;
  }
  container.innerHTML = state.logs.map(log => `
    <div class="log-entry ${log.success ? 'success' : 'fail'}">
      <div class="log-dice">
        <div class="log-die hope" title="Hope">‚öê ${log.hope}</div>
        <div class="log-die fear" title="Fear">‚öë ${log.fear}</div>
        <div class="log-die sound" title="Soundtrack">‚ô™ ${log.sound}</div>
      </div>
      <div class="log-details">
        <span class="log-result ${log.success ? 'success' : 'fail'}">${log.success ? 'Success' : 'Incomplete'}</span>
        <div class="log-soundtrack">${escapeHtml(log.soundtrack)}</div>
        <div class="log-duration">${log.duration} minutes</div>
      </div>
      <div class="log-timestamp">${escapeHtml(log.timestamp)}</div>
    </div>
  `).join('');
}

function exportCSV() {
  if (state.logs.length === 0) { showToast('No logs to export'); return; }
  const headers = ['Timestamp','Hope Roll','Fear Roll','Soundtrack Roll','Soundtrack','Duration (min)','Success'];
  const rows = state.logs.map(log => [
    `"${log.timestamp}"`,
    log.hope,
    log.fear,
    log.sound,
    `"${(log.soundtrack || '').replace(/"/g,'""')}"`,
    log.duration,
    log.success ? 'Yes' : 'No'
  ]);
  const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `roll4focus-logs-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Logs exported!');
}

function clearLogs() {
  if (confirm('Clear all session logs?')) {
    state.logs = [];
    saveState();
    renderLogs();
  }
}

// ============================================================
// HELPERS
// ============================================================
function flashInspiration() {
  const el = document.getElementById('inspFlash');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 600);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// ============================================================
// INIT
// ============================================================
function init() {
  loadState();
  document.getElementById('inspirationVal').textContent = state.inspiration;
  document.getElementById('penaltyVal').textContent = state.penalty;
  document.getElementById('baseTimeSetting').value = state.baseTime;
  document.getElementById('dcDefaultSetting').value = state.dcDefault;
  document.getElementById('minionDcDefaultSetting').value = state.minionDcDefault;
  document.getElementById('hopeFearDieSetting').value = state.hopeFearDie;
  document.getElementById('soundtrackDieSetting').value = state.soundtrackDie;
  document.getElementById('tickingToggle').checked = state.tickingEnabled;
  document.getElementById('startSoundToggle').checked = state.startSoundEnabled;
  document.getElementById('inspirationSoundToggle').checked = state.inspirationSoundEnabled;
  updateBreakDC();
  buildSoundtrackTable();
  loadNotes();
  loadNotesTab();

  // Restore persisted sound file
  try {
    const saved = JSON.parse(localStorage.getItem('r4f_sound') || 'null');
    if (saved && saved.data) {
      document.getElementById('timerSound').src = saved.data;
      document.getElementById('soundFileName').textContent = saved.name;
      state.soundFileURL = saved.data;
    }
  } catch(e) {}

  // Restore start sound
  try {
    const saved = JSON.parse(localStorage.getItem('r4f_start_sound') || 'null');
    if (saved && saved.data) {
      document.getElementById('startSound').src = saved.data;
      document.getElementById('startSoundFileName').textContent = saved.name;
    }
  } catch(e) {}

  // Restore inspiration sound
  try {
    const saved = JSON.parse(localStorage.getItem('r4f_inspiration_sound') || 'null');
    if (saved && saved.data) {
      document.getElementById('inspirationSound').src = saved.data;
      document.getElementById('inspirationSoundFileName').textContent = saved.name;
    }
  } catch(e) {}
}

init();
</script>
</body>
</html>
